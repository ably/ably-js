/*
 Copyright 2016, Ably

 Ably JavaScript Library v0.8.26
 https://github.com/ably/ably-js

 Ably Realtime Messaging
 https://www.ably.io

 Released under the Apache Licence v2.0
*/
(function(){function m(b){for(var c="",a=0;a<b;a++)c+="abcdef0123456789".charAt(Math.floor(16*Math.random()));return c}function r(b){var c=p[b];c||(c=d.ably.channels.get(b),d.ablyCipherParams&&c.setOptions({cipher:d.ablyCipherParams}),p[b]=c);return c}function z(b,c){delete d.ablyCipherParamsPending;if(b)return h("Unable to set up encryption parameters for secure messaging");d.ablyCipherParams=c;for(var a in p)p[a].setOptions({cipher:d.ablyCipherParams});for(a=0;a<q.length;a++){var e=q[a];d.publish({channel:e.channel,
callback:e.callback,error:e.error,message:e.message})}q=[]}function t(b,c){for(var a in n){var e=n[a];"connect"==b?e.hasConnectedOnce?e.reconnect&&e.reconnect(a):(e.connect&&e.connect(a),e.hasConnectedOnce=!0):e[b]&&e[b](a)}}var g="undefined"===typeof document?null:document.getElementById("pubnub"),v,w,x;g&&g.getAttribute("publish_key");g&&g.getAttribute("subscribe_key");v=g&&g.getAttribute("origin")||"";w=g&&g.getAttribute("uuid")||"";x=g&&"on"==g.getAttribute("ssl");var p={},n={},q=[],d={},k=function(){},
h=window.console&&function(b){console.log(b)}||k;d.Ably="undefined"!==typeof window?window.Ably:"undefined"!==typeof Ably?Ably:require("../..");d.secure=function(b,c){return b.cipher_key?d.init(b,c):h("Missing cipher_key")};d.init=function(b,c){var a=b.ably_key,e=b.ssl||x,f=b.origin||v,l=b.tlsorigin||"",u=b.uuid||w;if(!a)return h("Missing ably_key");a={key:a,tls:e};u&&0!=u.length&&(a.clientId=u);f&&0!=f.length&&(f=f.split(":"),a.restHost=a.realtimeHost=f[0],1<f.length&&(a.port=f[1]));l&&0!=l.length&&
(f=l.split(":"),1<f.length&&(a.tlsPort=f[1]));d.ablyOptions=a;d.ably=new Ably.Realtime(a);b.cipher_key&&(d.ablyCipherParamsPending=!0,z(null,d.Ably.Realtime.Crypto.getDefaultParams({key:b.cipher_key})));d.ably.connection.on(function(a){switch(a.current){case "connected":t("connect");break;case "disconnected":case "suspended":case "closed":t("disconnect",a.reason);break;case "failed":t("error",a.reason)}});return d};d.get_uuid=function(){return d.ablyOptions?d.ablyOptions.clientId:null};d.shutdown=
function(b){var c=d.ably.connection,a=function(e){c.off("closed",a);b(e.current)};d.ably.connection.on("closed",a);d.ably.close();delete d.ably;delete d.ablyOptions;delete d.ablyCipherParams;n={};p={};q=[]};d.history=function(b,c){c=b.callback||c;var a=b.count||100,e=b.channel,d=b.error||k,l=b.reverse||!1;if(!e)return h("Missing Channel");if(!c)return h("Missing Callback");e=r(e);a={direction:l?"backwards":"forwards",limit:a};b.start&&(a.start=Number(b.start)/1E4);b.end&&(a.end=Number(b.end)/1E4);
e.history(a,function(a,b){if(a)d(a);else{for(var e=[],l=null,h=null,k=0;k<b.length;k++){var y=b[k];l||(l=h=y.timestamp);e.push(y.data)}c([e,l,h])}})};d.time=function(b){d.ably.time(function(c,a){c?(h("PUBNUB.time: Error: "+c),b(0)):b(1E4*Number(a))})};d.publish=function(b,c){c=c||b.callback||k;var a=b.message,e=b.channel,f=b.error||k,l=Date.now();if(!a)return h("Missing Message");if(!e)return h("Missing Channel");d.ablyCipherParamsPending?q.push({channel:e,message:a,error:f,callback:c}):r(e).publish("",
a,function(a){a?f({error:a}):c([1,"Sent",(1E4*l).toString()])})};d.here_now=function(b,c){c=c||b.callback;var a=b.error||k,e=b.channel;if(e)if(c)if(e=n[e])if(e=e.ablyChannel.presence.get()){for(var a=Array(e.length),d=0;d<e.length;d++)a[d]=e[d].clientId;c({uuids:a,occupancy:a.length})}else a("Presence not available for channel");else a("Not subscribed to channel");else a("Missing callback");else a("Missing channel")};d.uuid=function(b){var d=m(8)+"-"+m(4)+"-"+m(4)+"-"+m(4)+"-"+m(12);b&&b(d);return d};
d.subscribe=function(b,c){c=c||b.callback||b.message;var a=b.channel;if(!a)return h("Missing Channel");if(!c)return h("Missing Callback");"[object Array]"!=Object.prototype.toString.call(a)&&(a=a.split(","));for(var e=function(a,b,c){if(n[a])return h("Already Connected");var e=function(a){b(a.data)},f=r(a),g=c.presence;if(g){var m=function(a){"update"!=a.action&&g({action:"enter"==a.action?"join":"leave",uuid:a.clientId,timestamp:1E4*Date.now(),occupancy:f.presence.get().length})};f.presence.subscribe("enter",
function(a){a.action="enter";m(a)});f.presence.subscribe("leave",function(a){a.action="leave";m(a)})}f.subscribe(e);c={callback:e,ablyChannel:f,error:c.error||k,connect:c.connect||k,reconnect:c.reconnect||k,disconnect:c.disconnect||k,presence:c.presence||k,hasConnectedOnce:!1};n[a]=c;"connected"==d.ably.connection.state&&(c.hasConnectedOnce=!0,c.connect&&c.connect(a));d.ablyOptions.clientId&&f.presence.enter(function(a){})},f=0;f<a.length;f++)e(a[f],c,b)};d.unsubscribe=function(b,c){c=c||b.callback||
k;var a=b.channel;if(a){"[object Array]"!=Object.prototype.toString.call(a)&&(a=a.split(","));for(var d=0;d<a.length;d++){var f=a[d],h=c,g=f&&n[f];g&&(g.ablyChannel.unsubscribe(g.callback),delete n[f],h({action:"leave"}))}}};"undefined"===typeof window?module.exports=d:window.PUBNUB=d})();
